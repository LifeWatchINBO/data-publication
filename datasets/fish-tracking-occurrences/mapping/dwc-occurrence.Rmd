---
title: "Darwin Core mapping for fish tracking data"
author: "Peter Desmet"
date: "2017-05-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## General data publication agreements

* Publish unbinned data. This required for e.g. data from the Albertkanaal, which cannot be analysed correctly with minute bins. Those unbinned data can be retrieved from `vliz.detections`
* Publish detections: location + time + species
* Receivers are grouped in _network projects_ (generally not under moratoria), transmitters are grouped in _animal projects_ (often under moratoria). Data should be filtered on both types of projects that are **not under a moratorium**.
* Two output formats: simple Occurrence Darwin Core and [OBIS ENV](https://bdj.pensoft.net/article/10989/)

## Preprocessing

* Get data from `vliz.detections` (is unbinned)
* Once data can be uploaded in VRL format (rather than CSV), datetimes will have millisecond information as well.

## Transform data

```{r}
# Set libPaths.
.libPaths("/Users/peter_desmet/.exploratory/R/3.3")

# Load required packages.
library(janitor)
library(lubridate)
library(hms)
library(tidyr)
library(stringr)
library(readr)
library(forcats)
library(RcppRoll)
library(dplyr)
library(exploratory)

# Steps to produce the output
exploratory::read_delim_file("/Users/peter_desmet/Downloads/20170516_etn_sample_detections_view.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c("","NA") , locale=locale(encoding = "UTF-8", decimal_mark = "."), trim_ws = FALSE , progress = FALSE) %>% exploratory::clean_data_frame() %>%
  arrange(transmitter, datetime) %>%
  
  # occurrenceID: use "id_pk" from DB
  mutate(occurrenceID = paste(transmitter, format(datetime, "%Y%m%d%H%M%S"), sep = ":")) %>%
  mutate(type = "Event") %>%
  mutate(language = "en") %>%
  mutate(license = "http://creativecommons.org/publicdomain/zero/1.0/") %>%
  # rightsHolder: use "group" from animal project 
  mutate(rightsHolder = "INBO") %>%
  mutate(accessRights = "http://www.inbo.be/en/norms-for-data-use") %>%
  mutate(datasetID = "no DOI yet") %>%
  mutate(institutionCode = "INBO") %>%
  mutate(datasetName = "TODO") %>%
  mutate(basisOfRecord = "MachineObservation") %>%
  mutate(informationWithheld = "see metadata") %>%
  # dynamicProperties:
  # - transmitterID
  # - receiverID
  # - animal projectnaam
  # - ---
  # - catchlocation
  # - catchtime
  # - catchweight
  # - catchlength
  mutate(dynamicProperties = paste("{\"receiver\":\"", receiver, "\", \"network_project_name\":\"", network_project_name, "\"}", sep = "")) %>%
  # sex: should be available for some animals
  mutate(sex = "TODO") %>%
  # lifeStage: should be at time of tagging
  mutate(lifeStage = "adult TODO") %>%
  # organismID: should not be transmitterID, as that one can be replaced/reused. Find a good animalID
  mutate(organismID = transmitter) %>%
  # samplingProtocol: should be ID of datapaper
  mutate(samplingProtocol = "TODO") %>%
  # samplingEffort: do not use
  mutate(samplingEffort = "TODO") %>%
  # eventDate: format in milliseconds
  mutate(eventDate = format(datetime,"%Y-%m-%dT%H:%M:%SZ")) %>%
  # locationID: should be station_name
  mutate(locationID = station_name) %>%
  # waterBody: maybe provide, based on marine regions gazetteer
  mutate(waterBody = "TODO maybe") %>%
  # countryCode: maybe provide
  mutate(countryCode = "TODO maybe") %>%
  # locality: do not provide
  mutate(locality = location_name) %>%
  # minimumDepthInMeters: pressure tags could have depth info, but not retrieved via VRL yet.
  # Also no info on the depth of reciever, which would be a crude metric for depth of animal anyway
  mutate(minimumDepthInMeters = "TODO") %>%
  mutate(decimalLatitude = sprintf("%.5f", round(latitude, digits = 5))) %>%
  mutate(decimalLongitude = sprintf("%.5f", round(longitude, digits = 5))) %>%
  mutate(geodeticDatum = "WGS84") %>%
  # coordinateUncertaintyInMeters: to be reviewed, probably:
  # - zee / westerschelde: 200m on average, 500m extreme
  # - albertkanaal: 2km
  mutate(coordinateUncertaintyInMeters = "TODO") %>%
  # georeferenceSources: not always obtained by GPS, sometimes map
  mutate(georeferenceSources = "GPS") %>%
  # georeferenceVerificationStatus: are unverified
  mutate(georeferenceVerificationStatus = "unverified") %>%
  mutate(scientificName = scientific_name) %>%
  mutate(kingdom = "Animalia") %>%
  mutate(taxonRank = "species") %>%
  mutate(vernacularName = case_when(.$scientific_name == "Gadus morhua" ~ "Atlantic cod", .$scientific_name == "Anguilla anguilla" ~ "European eel")) %>%
  select(-X1, -receiver, -transmitter, -transmitter_name, -transmitter_serial, -sensor_value, -sensor_unit, -sensor2_value, -sensor2_unit, -station_name, -datetime, -id_pk, -qc_flag, -file, -latitude, -longitude, -deployment_fk, -scientific_name, -location_name, -deployment_station_name, -deploy_date_time, -animal_project, -animal_project_name, -animal_project_code, -animal_moratorium, -network_project, -network_project_name, -network_project_code, -network_moratorium, -signal_to_noise_ratio, -detection_file_id)
```
